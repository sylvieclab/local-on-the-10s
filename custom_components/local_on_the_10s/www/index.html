<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local on the 10s</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', 'Helvetica', sans-serif;
            font-weight: bold;
            background: #1a4570;
            overflow: hidden;
            height: 100vh;
            color: white;
            image-rendering: auto;
            position: relative;
        }

        /* Background image layer with rotation */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: var(--bg-image, url('/local_on_the_10s/backgrounds/clouds%20at%20dusk.jpg'));
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            transition: opacity 1s ease-in-out;
            z-index: 0;
        }

        /* Dark overlay on background */
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                /* Scan line overlay */
                repeating-linear-gradient(
                    0deg,
                    rgba(0, 0, 0, 0.15) 0px,
                    transparent 1px,
                    transparent 2px,
                    rgba(0, 0, 0, 0.15) 3px
                ),
                /* Dark gradient overlay */
                linear-gradient(180deg, 
                    rgba(26, 69, 112, 0.75) 0%, 
                    rgba(39, 90, 136, 0.70) 20%,
                    rgba(58, 111, 160, 0.65) 40%,
                    rgba(77, 133, 184, 0.60) 60%,
                    rgba(98, 153, 204, 0.65) 80%,
                    rgba(120, 174, 216, 0.70) 100%);
            pointer-events: none;
            z-index: 1;
        }

        #app {
            width: 100%;
            height: 100vh;
            position: relative;
            z-index: 2;
        }
        
        /* When in iframe/card, make body and app fill container */
        body.in-card {
            height: 100%;
        }
        
        body.in-card #app {
            height: 100%;
        }

        /* Film grain overlay for authentic broadcast look */
        #app::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAMAAABHPGVmAAAABlBMVEX///8AAABVwtN+AAABVUlEQVR4nO2YQQ7DIAxE7f0PTYe2qpQgO8ZmRZf5qxDvSQYcjLHW2l9bL6211tpfWy+ttdZaa39tvbT22l9bL6211v7aemmt/bX10lprrf219dL+v9b+2npprb221v7aemlrre219dL+v9b+2npprbW+tl5aa339tfXSWmt9bb201tpfWy+ttb+2Xlpr7a+tl9Zaa39tvbTW/tp6aa21v7ZeWmvtr62X1lr7a+ultdb+2npprb221v7aemlrrfW19dJaa31tvbTW2l9bL6211tpfWy+ttb+2Xlpr7a+tl9Zaa39tvbTW2l9bL6219tfWS2ut/bX10lprrf219dJaa39tvbTW/tp6aa21v7ZeWmvtr62X1lprf229tNZaX1svrb221v7aemlrrfW19dJaa31tvbTW2l9bL621v7ZeWmvtr62X1lr7a+ultdb+2npprb221v7aemlrrbW/tl5aa+2vrZf2BestEXXt5YsaAAAAAElFTkSuQmCC');
            opacity: 0.02;
            pointer-events: none;
            z-index: 999;
            animation: grainAnimate 0.5s steps(3) infinite;
        }

        @keyframes grainAnimate {
            0%, 100% { transform: translate(0, 0); }
            10% { transform: translate(-5%, -5%); }
            20% { transform: translate(-10%, 5%); }
            30% { transform: translate(5%, -10%); }
            40% { transform: translate(-5%, 15%); }
            50% { transform: translate(-10%, 5%); }
            60% { transform: translate(15%, 0); }
            70% { transform: translate(0, 10%); }
            80% { transform: translate(-15%, 0); }
            90% { transform: translate(10%, 5%); }
        }

        /* Main content */
        .content {
            position: relative;
            z-index: 10;
            height: calc(100% - 70px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }

        /* Section header - 2005 broadcast style */
        .section-header {
            background: 
                linear-gradient(180deg, 
                    rgba(35, 55, 75, 0.85) 0%, 
                    rgba(25, 40, 60, 0.90) 50%,
                    rgba(18, 30, 48, 0.92) 100%);
            padding: 8px 30px;
            font-size: 32px;
            font-weight: normal;
            text-transform: lowercase;
            margin-bottom: 0;
            text-shadow: 
                0 0 8px rgba(255, 255, 255, 0.4),
                2px 2px 4px rgba(0, 0, 0, 0.9),
                0 0 12px rgba(255, 255, 255, 0.2);
            letter-spacing: 1px;
            width: 100%;
            max-width: 950px;
            border-top-left-radius: 6px;
            border-top-right-radius: 6px;
            border: 1px solid rgba(80, 120, 160, 0.4);
            border-bottom: none;
            box-shadow: 
                0 3px 8px rgba(0, 0, 0, 0.8),
                inset 0 1px 0 rgba(255, 255, 255, 0.1),
                0 0 20px rgba(0, 0, 0, 0.3);
            filter: blur(0.3px);
        }

        /* Weather panels */
        .weather-section {
            position: absolute;
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 60px 40px 90px;
        }

        .weather-section.active {
            display: flex;
            animation: fadeIn 0.8s ease-in;
        }
        
        /* Full-screen radar layout */
        .weather-section.radar-fullscreen {
            padding: 0;
            justify-content: flex-start;
            overflow: hidden;
        }
        
        /* Combined radar header banner - two-row centered design */
        .weather-section.radar-fullscreen .local-header {
            display: block;
            position: absolute;
            top: 0px;
            left: 0;
            transform: none;
            z-index: 100;
            width: 100%;
            max-width: none;
        }
        
        /* Row 1: Title and subtitle on same line */
        .weather-section.radar-fullscreen .radar-banner-row1 {
            background: linear-gradient(180deg, 
                rgba(35, 55, 75, 0.92) 0%, 
                rgba(25, 40, 60, 0.94) 100%);
            padding: 12px 30px;
            text-align: center;
            box-shadow: 
                0 3px 8px rgba(0, 0, 0, 0.8),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(80, 120, 160, 0.4);
            border-bottom: none;
        }
        
        .weather-section.radar-fullscreen .radar-banner-title {
            font-size: 24px;
            font-weight: bold;
            text-transform: lowercase;
            letter-spacing: 1.5px;
            color: white;
            text-shadow: 
                0 0 10px rgba(255, 255, 255, 0.4),
                2px 2px 4px rgba(0, 0, 0, 0.9);
        }
        
        /* Row 2: Radar type and location split */
        .weather-section.radar-fullscreen .radar-banner-row2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            background: linear-gradient(180deg, 
                rgba(25, 40, 60, 0.94) 0%, 
                rgba(18, 30, 48, 0.96) 100%);
            border-bottom-left-radius: 6px;
            border-bottom-right-radius: 6px;
            box-shadow: 
                0 5px 15px rgba(0, 0, 0, 0.8),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(80, 120, 160, 0.4);
            border-top: 1px solid rgba(100, 140, 180, 0.3);
            overflow: hidden;
        }
        
        .weather-section.radar-fullscreen .section-header {
            position: relative;
            top: auto;
            left: auto;
            transform: none;
            background: transparent;
            padding: 10px 20px;
            font-size: 22px;
            font-weight: normal;
            text-transform: lowercase;
            text-align: center;
            color: white;
            text-shadow: 
                0 0 8px rgba(255, 255, 255, 0.3),
                2px 2px 4px rgba(0, 0, 0, 0.8);
            letter-spacing: 1px;
            border: none;
            box-shadow: none;
            border-radius: 0;
            border-right: 1px solid rgba(100, 140, 180, 0.3);
            margin: 0;
            max-width: none;
        }
        
        .weather-section.radar-fullscreen .location-header {
            position: relative;
            top: auto;
            left: auto;
            transform: none;
            background: linear-gradient(180deg, 
                rgba(255, 255, 255, 0.25) 0%,
                rgba(255, 255, 255, 0) 50%),
            linear-gradient(180deg, 
                #d8f050 0%, 
                #c8e048 15%,
                #b0cc38 40%,
                #98b828 70%,
                #80a020 100%);
            padding: 10px 20px;
            font-size: 22px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-align: center;
            color: white;
            text-shadow: 
                0 0 10px rgba(255, 255, 255, 0.5),
                2px 2px 3px rgba(0, 0, 0, 0.8);
            border: none;
            box-shadow: inset 0 2px 0 rgba(255, 255, 255, 0.3);
            border-radius: 0;
            margin: 0;
            max-width: none;
        }
        
        .weather-section.radar-fullscreen .data-panel {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            max-width: none;
            background: transparent;
            border: none;
            box-shadow: none;
            border-radius: 0;
            padding: 0;
        }
        
        .weather-section.radar-fullscreen .data-panel::before,
        .weather-section.radar-fullscreen .data-panel::after {
            display: none;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Location header bar - 2005 glossy gel style */
        .location-header {
            background: 
                /* Glossy highlight */
                linear-gradient(180deg, 
                    rgba(255, 255, 255, 0.25) 0%,
                    rgba(255, 255, 255, 0) 50%),
                /* Main gradient */
                linear-gradient(180deg, 
                    #d8f050 0%, 
                    #c8e048 15%,
                    #b0cc38 40%,
                    #98b828 70%,
                    #80a020 100%);
            padding: 13px 30px;
            font-size: 30px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 3px;
            box-shadow: 
                0 5px 15px rgba(0, 0, 0, 0.7),
                inset 0 3px 0 rgba(255, 255, 255, 0.4),
                inset 0 -3px 0 rgba(0, 0, 0, 0.4),
                0 0 30px rgba(0, 0, 0, 0.4);
            margin-bottom: 0;
            width: 100%;
            max-width: 950px;
            text-align: center;
            color: white;
            text-shadow: 
                0 0 10px rgba(255, 255, 255, 0.5),
                2px 2px 3px rgba(0, 0, 0, 0.8),
                0 0 15px rgba(200, 220, 80, 0.6);
            border-left: 1px solid rgba(0, 0, 0, 0.6);
            border-right: 1px solid rgba(0, 0, 0, 0.6);
            position: relative;
            filter: blur(0.3px);
        }

        /* Data panel - 2005 glossy broadcast style */
        .data-panel {
            background: 
                /* Glass highlight */
                linear-gradient(180deg, 
                    rgba(120, 160, 200, 0.15) 0%,
                    rgba(80, 120, 180, 0) 30%),
                /* Main gradient */
                linear-gradient(180deg, 
                    rgba(45, 80, 135, 0.88) 0%,
                    rgba(38, 68, 118, 0.90) 40%,
                    rgba(32, 58, 105, 0.92) 70%,
                    rgba(28, 50, 92, 0.94) 100%);
            border: 1px solid rgba(70, 110, 150, 0.5);
            border-top: 2px solid rgba(90, 130, 180, 0.4);
            box-shadow: 
                0 10px 25px rgba(0, 0, 0, 0.8),
                inset 0 2px 0 rgba(150, 190, 230, 0.2),
                inset 0 -2px 8px rgba(0, 0, 0, 0.4),
                0 0 40px rgba(0, 0, 0, 0.5);
            padding: 40px;
            width: 100%;
            max-width: 950px;
            border-bottom-left-radius: 6px;
            border-bottom-right-radius: 6px;
            position: relative;
            filter: blur(0.3px);
        }

        /* Heavy noise texture overlay for broadcast look */
        .data-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwBAMAAAClLOS0AAAAElBMVEUAAAAAAAAAAAAAAAAAAAAAAADgKxmiAAAABnRSTlMCCwwNDhGXV8FhAAAAPklEQVQ4y2NgAAOGIJCBESBiABFMAFEMIAIMAAEQxQgQxQQQBREMIEVMQFFMAFEQwQhSBBYFKwIrYoRrAgkCAKSzBTcnN4TpAAAAAElFTkSuQmCC');
            opacity: 0.08;
            pointer-events: none;
            border-radius: inherit;
        }

        /* Additional glass reflection effect */
        .data-panel::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0%;
            right: 0%;
            height: 50%;
            background: linear-gradient(180deg, 
                rgba(255, 255, 255, 0.08) 0%,
                rgba(255, 255, 255, 0.04) 50%,
                transparent 100%);
            pointer-events: none;
            border-radius: inherit;
        }

        /* Radar map container - fills full screen */
        .radar-container {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            overflow: hidden;
            background: #1a2a3a;
        }

        .radar-map {
            width: 100%;
            height: 100%;
        }

        /* Hide Leaflet attribution and zoom controls */
        .leaflet-control-attribution,
        .leaflet-control-zoom {
            display: none !important;
        }

        /* Radar loading indicator */
        .radar-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 18px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            z-index: 1000;
        }
        
        /* Radar timestamp overlay - styled like Local On The 8's */
        .radar-timestamp {
            position: absolute;
            bottom: 90px;
            left: 20px;
            background: rgba(0, 0, 0, 0.75);
            padding: 8px 15px;
            border-radius: 4px;
            font-size: 18px;
            font-weight: bold;
            z-index: 1001;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
            letter-spacing: 0.5px;
        }

        /* Current Conditions Layout - 2005 TWO COLUMN */
        .current-layout {
            display: grid;
            grid-template-columns: 340px 1fr;
            gap: 45px;
            align-items: stretch;
            min-height: 350px;
        }

        /* LEFT PANEL - Icon and Temperature */
        .current-icon-temp {
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-right: 3px solid rgba(80, 120, 180, 0.4);
            padding-right: 35px;
            position: relative;
        }

        /* Add subtle vertical gradient to divider */
        .current-icon-temp::after {
            content: '';
            position: absolute;
            right: -3px;
            top: 10%;
            bottom: 10%;
            width: 1px;
            background: linear-gradient(180deg, 
                transparent 0%,
                rgba(120, 160, 210, 0.5) 50%,
                transparent 100%);
        }

        .weather-icon-large {
            width: 160px;
            height: 160px;
            margin: 0 auto 18px;
            filter: 
                drop-shadow(0 6px 12px rgba(0, 0, 0, 0.6))
                drop-shadow(0 0 20px rgba(255, 255, 255, 0.2));
        }

        .condition-text {
            font-size: 28px;
            margin: 18px 0 28px;
            font-weight: bold;
            letter-spacing: 1px;
            text-shadow: 
                2px 2px 4px rgba(0, 0, 0, 0.8),
                0 0 10px rgba(0, 0, 0, 0.5);
        }

        .temp-large {
            font-size: 140px;
            font-weight: bold;
            line-height: 0.85;
            text-shadow: 
                4px 4px 8px rgba(0, 0, 0, 0.8),
                0 0 20px rgba(255, 255, 255, 0.3);
            letter-spacing: -8px;
            font-family: Arial, Helvetica, sans-serif;
        }

        /* RIGHT PANEL - Details Grid */
        .current-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px 40px;
            padding-left: 25px;
            align-content: center;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
        }

        .detail-label {
            text-transform: uppercase;
            font-weight: bold;
            font-size: 20px;
            letter-spacing: 1.2px;
            color: #a8c8e8;
            text-shadow: 
                1px 1px 2px rgba(0, 0, 0, 0.8);
        }

        .detail-value {
            font-weight: bold;
            text-align: right;
            font-size: 26px;
            letter-spacing: 0.3px;
            text-shadow: 
                2px 2px 3px rgba(0, 0, 0, 0.8);
            font-family: Arial, Helvetica, sans-serif;
            color: #ffffff;
        }

        /* Forecast Grid */
        .forecast-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 14px;
        }

        .forecast-card {
            background: linear-gradient(180deg, 
                rgba(55, 100, 165, 0.75) 0%,
                rgba(45, 85, 145, 0.75) 100%);
            padding: 20px 10px;
            text-align: center;
            border: 1px solid rgba(70, 110, 170, 0.5);
            border-radius: 3px;
            box-shadow: 
                0 3px 6px rgba(0, 0, 0, 0.5),
                inset 0 1px 0 rgba(100, 150, 210, 0.2);
        }

        .forecast-day {
            font-size: 22px;
            font-weight: bold;
            text-transform: uppercase;
            margin-bottom: 15px;
            letter-spacing: 0.8px;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.8);
        }

        .forecast-icon {
            width: 64px;
            height: 64px;
            margin: 18px auto;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.6));
        }

        .forecast-condition {
            font-size: 15px;
            margin: 10px 0;
            line-height: 1.3;
            min-height: 45px;
            font-weight: normal;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }

        .forecast-temps {
            font-size: 34px;
            font-weight: bold;
            margin-top: 10px;
            line-height: 1.1;
            text-shadow: 2px 2px 3px rgba(0, 0, 0, 0.8);
        }

        .temp-high {
            color: #ffffff;
        }

        .temp-low {
            color: #b3e5fc;
        }

        /* Text forecast */
        .text-forecast {
            font-size: 22px;
            line-height: 1.6;
            text-align: left;
            max-width: 850px;
            margin: 0 auto;
            font-weight: normal;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
            color: #e8f0f8;
        }

        .forecast-period {
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 26px;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.8);
            color: #5fc4d4;
        }

        .text-forecast p {
            margin-bottom: 28px;
        }

        /* Footer info bar - 2005 style */
        .footer-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(180deg, 
                rgba(20, 35, 50, 0.92) 0%,
                rgba(15, 25, 40, 0.95) 100%);
            padding: 18px 45px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 24px;
            z-index: 100;
            box-shadow: 
                0 -4px 15px rgba(0, 0, 0, 0.6),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            border-top: 2px solid rgba(60, 90, 120, 0.4);
        }

        .footer-left {
            display: flex;
            align-items: center;
            gap: 18px;
        }
        .footer-center {
            display: flex; 
            align-items: center; 
            gap: 20px;
        }

        .current-location {
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        .current-temp-small {
            font-weight: bold;
            font-size: 28px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        .time-display {
            font-weight: bold;
            font-size: 28px;
            letter-spacing: 1px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        .moon-display {
            font-weight: bold;
            font-size: 28px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        /* Hide stacked layout by default, show inline */
        .sun-display-large,
        .moon-display-large {
            display: block;
            font-size: 28px;
        }

        .sun-moon-display {
            display: none;
            text-align: center;
        }

        .sun-times, .moon-times {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        .twc-logo {
            background: linear-gradient(180deg, 
                #0077dd 0%,
                #0066cc 50%,
                #0055aa 100%);
            padding: 11px 18px;
            border-radius: 5px;
            font-weight: bold;
            font-size: 11px;
            letter-spacing: 0.8px;
            line-height: 1.4;
            text-align: center;
            box-shadow: 
                0 3px 8px rgba(0, 0, 0, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.25),
                inset 0 -1px 0 rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 100, 200, 0.6);
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        /* Loading */
        .loading {
            font-size: 28px;
            text-align: center;
            padding: 40px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        /* Local on the 10s header */
        .local-header {
            position: absolute;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 50;
            text-align: center;
        }
        
        /* Hide main local-header when radar section is active */
        body:has(.weather-section.radar-fullscreen.active) > #app > .local-header {
            display: none;
        }

        .local-title {
            font-size: 48px;
            font-weight: bold;
            text-transform: lowercase;
            letter-spacing: 2px;
            color: white;
            text-shadow: 
                0 0 20px rgba(255, 255, 255, 0.6),
                3px 3px 6px rgba(0, 0, 0, 0.9),
                0 0 30px rgba(255, 255, 255, 0.3);
            margin-bottom: 5px;
        }

        .local-subtitle {
            font-size: 20px;
            font-weight: normal;
            text-transform: uppercase;
            letter-spacing: 3px;
            color: #b3e5fc;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        /* Responsive adjustments */
        @media (max-width: 1200px) {
            .local-title {
                font-size: 32px;
            }
            .local-subtitle {
                font-size: 16px;
            }
            .section-header {
                font-size: 26px;
            }
            .location-header {
                font-size: 24px;
                padding: 10px 25px;
            }
            .data-panel {
                padding: 25px;
            }
            .temp-large {
                font-size: 110px;
            }
            .weather-icon-large {
                width: 130px;
                height: 130px;
            }
        }

        @media (max-width: 900px) {
            .local-header {
                top: 5px;
            }
            .local-title {
                font-size: 24px;
                margin-bottom: 2px;
            }
            .local-subtitle {
                font-size: 12px;
            }
            .content {
                padding: 15px 15px 58px;
            }
            .section-header {
                font-size: 18px;
                padding: 4px 12px;
            }
            .location-header {
                font-size: 17px;
                padding: 5px 12px;
            }
            .data-panel {
                padding: 15px;
            }
            .radar-timestamp {
                font-size: 14px;
                padding: 6px 12px;
                bottom: 80px;
                left: 10px;
            }
            
            .weather-section.radar-fullscreen .local-header {
                top: 0px;
                width: 100%;
            }
            
            .weather-section.radar-fullscreen .radar-banner-title {
                font-size: 18px;
            }
            
            .weather-section.radar-fullscreen .radar-banner-row1 {
                padding: 8px 20px;
            }
            
            .weather-section.radar-fullscreen .section-header {
                font-size: 16px;
                padding: 8px 15px;
            }
            
            .weather-section.radar-fullscreen .location-header {
                font-size: 16px;
                padding: 8px 15px;
            }
            .current-layout {
                grid-template-columns: 200px 1fr;
                gap: 20px;
                min-height: auto;
            }
            .current-icon-temp {
                padding-right: 15px;
            }
            .temp-large {
                font-size: 75px;
                letter-spacing: -5px;
            }
            .weather-icon-large {
                width: 85px;
                height: 85px;
                margin-bottom: 8px;
            }
            .condition-text {
                font-size: 18px;
                margin: 8px 0 12px;
            }
            .current-details {
                grid-template-columns: 1fr 1fr;
                gap: 8px 20px;
                padding-left: 10px;
            }
            .detail-row {
                padding: 4px 0;
            }
            .detail-label {
                font-size: 14px;
            }
            .detail-value {
                font-size: 18px;
            }
            .forecast-grid {
                grid-template-columns: repeat(7, 1fr);
                gap: 6px;
            }
            .forecast-card {
                padding: 10px 4px;
            }
            .forecast-day {
                font-size: 14px;
                margin-bottom: 6px;
            }
            .forecast-icon {
                width: 40px;
                height: 40px;
                margin: 8px auto;
            }
            .forecast-condition {
                font-size: 11px;
                min-height: 30px;
            }
            .forecast-temps {
                font-size: 20px;
                margin-top: 4px;
            }
            .text-forecast {
                font-size: 16px;
                line-height: 1.4;
            }
            .text-forecast p {
                margin-bottom: 15px;
            }
            .forecast-period {
                font-size: 20px;
                margin-bottom: 6px;
            }
            .footer-bar {
                padding: 6px 12px;
                font-size: 12px;
            }
            .footer-left {
                flex-direction: column;
                gap: 3px;
                align-items: flex-start;
            }
            .time-display {
                font-size: 15px;
            }
            .sun-display {
                font-size: 16px;
            }
            .moon-display {
                font-size: 16px;
            }
            .current-temp-small {
                font-size: 16px;
            }
            .current-location {
                font-size: 15px;
            }
            .twc-logo {
                font-size: 8px;
                padding: 6px 10px;
            }
        }

        @media (max-width: 600px) {
            .local-header {
                top: 5px;
            }
            .local-title {
                font-size: 20px;
                margin-bottom: 1px;
            }
            .local-subtitle {
                font-size: 10px;
                letter-spacing: 1.5px;
            }
            .content {
                padding: 18px 12px 60px;
            }
            .section-header {
                font-size: 16px;
                padding: 4px 12px;
            }
            .location-header {
                font-size: 16px;
                padding: 6px 12px;
            }
            .data-panel {
                padding: 12px;
            }
            .current-layout {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            .current-icon-temp {
                border-right: none;
                border-bottom: 2px solid rgba(80, 120, 180, 0.4);
                padding-right: 0;
                padding-bottom: 12px;
            }
            .current-icon-temp::after {
                display: none;
            }
            .temp-large {
                font-size: 70px;
            }
            .weather-icon-large {
                width: 80px;
                height: 80px;
            }
            .condition-text {
                font-size: 16px;
            }
            .current-details {
                padding-left: 0;
                grid-template-columns: 1fr;
                gap: 8px;
            }
            .detail-label {
                font-size: 13px;
            }
            .detail-value {
                font-size: 16px;
            }
            .forecast-grid {
                grid-template-columns: repeat(auto-fit, minmax(65px, 1fr));
                gap: 5px;
            }
            .forecast-card {
                padding: 8px 3px;
            }
            .forecast-day {
                font-size: 13px;
            }
            .forecast-icon {
                width: 36px;
                height: 36px;
                margin: 6px auto;
            }
            .forecast-condition {
                font-size: 10px;
                min-height: 28px;
            }
            .forecast-temps {
                font-size: 18px;
            }
            .text-forecast {
                font-size: 14px;
            }
            .forecast-period {
                font-size: 16px;
            }
            .radar-timestamp {
                font-size: 12px;
                padding: 5px 10px;
                bottom: 75px;
                left: 8px;
            }
            
            .weather-section.radar-fullscreen .local-header {
                top: 0px;
                width: 98%;
            }
            
            .weather-section.radar-fullscreen .radar-banner-title {
                font-size: 14px;
                letter-spacing: 0.8px;
            }
            
            .weather-section.radar-fullscreen .radar-banner-row1 {
                padding: 6px 15px;
            }
            
            .weather-section.radar-fullscreen .radar-banner-row2 {
                grid-template-columns: 1fr;
            }
            
            .weather-section.radar-fullscreen .section-header {
                font-size: 14px;
                padding: 6px 10px;
                border-right: none;
                border-bottom: 1px solid rgba(100, 140, 180, 0.3);
            }
            
            .weather-section.radar-fullscreen .location-header {
                font-size: 14px;
                padding: 6px 10px;
            }
            .footer-bar {
                padding: 6px 12px;
                font-size: 13px;
                flex-direction: column;
                gap: 5px;
            }
            .footer-left {
                gap: 6px;
                flex-direction: row;
            }
            .footer-center {
                display: flex; 
                align-items: center; 
                gap: 15px;
            }
            .time-display {
                font-size: 15px;
            }
            .sun-display {
                font-size:15px;
            }
            .moon-display {
                font-size: 15px;
            }
            .current-temp-small {
                font-size: 16px;
            }
            .current-location {
                font-size: 16px;
            }
            .twc-logo {
                font-size: 9px;
                padding: 7px 10px;
            }
        }
        @media (max-width: 500px) {
            .local-header {
                top: 3px;
            }
            .local-title {
                font-size: 16px;
                margin-bottom: 0px;
            }
            .local-subtitle {
                font-size: 8px;
                letter-spacing: 0.8px;
            }
            .content {
                padding: 12px 8px 50px;
            }
            .section-header {
                font-size: 13px;
                padding: 3px 8px;
            }
            .location-header {
                font-size: 13px;
                padding: 4px 8px;
            }
            .data-panel {
                padding: 8px;
            }
            .temp-large {
                font-size: 55px;
            }
            .weather-icon-large {
                width: 60px;
                height: 60px;
            }
            .condition-text {
                font-size: 13px;
            }
            .detail-label {
                font-size: 11px;
            }
            .detail-value {
                font-size: 13px;
            }
            .forecast-grid {
                grid-template-columns: repeat(auto-fit, minmax(50px, 1fr));
                gap: 3px;
            }
            .forecast-card {
                padding: 5px 2px;
            }
            .forecast-day {
                font-size: 10px;
            }
            .forecast-icon {
                width: 28px;
                height: 28px;
                margin: 3px auto;
            }
            .forecast-condition {
                font-size: 8px;
                min-height: 20px;
            }
            .forecast-temps {
                font-size: 14px;
            }
            .text-forecast {
                font-size: 11px;
            }
            .forecast-period {
                font-size: 13px;
            }
            .radar-timestamp {
                font-size: 10px;
                padding: 4px 6px;
                bottom: 110px;
                left: 5px;
            }
            .radar-map{
                width: 100%;
                height: 77%;
                top: 40px;
            }
            
            .weather-section.radar-fullscreen .local-header {
                top: 0px;
                width: 100%;
            }
            
            .weather-section.radar-fullscreen .radar-banner-title {
                font-size: 11px;
                letter-spacing: 0.4px;
            }
            
            .weather-section.radar-fullscreen .radar-banner-row1 {
                padding: 4px 10px;
            }
            
            .weather-section.radar-fullscreen .radar-banner-row2 {
                grid-template-columns: 1fr 1fr;
            }
            .weather-section.radar-fullscreen .radar-banner-row2 {
                border-bottom-left-radius: 0px;
                border-bottom-right-radius: 0px;
            }
            
            .weather-section.radar-fullscreen .section-header {
                font-size: 11px;
                padding: 4px 6px;
                border-right: none;
                border-bottom: 1px solid rgba(100, 140, 180, 0.3);
            }
            
            .weather-section.radar-fullscreen .location-header {
                font-size: 11px;
                padding: 4px 6px;
            }
            .footer-bar {
                padding: 4px 8px;
                font-size: 10px;
            }
            .footer-left {
                gap: 3px;
                flex-direction: row;
            }
            .footer-center {
                display: flex; 
                align-items: center; 
                gap: 15px;
            }
            .time-display {
                font-size: 15px;
            }
            .sun-display {
                font-size:15px;
            }
            .moon-display {
                font-size: 15px;
            }
            .current-temp-small {
                font-size: 13px;
            }
            .current-location {
                font-size: 13px;
            }
            .twc-logo {
                font-size: 7px;
                padding: 5px 6px;
            }
            .current-layout {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }
            .current-icon-temp {
                border-right: none;
                border-bottom: none;
                padding-right: 0;
                padding-bottom: 10px;
            }
            
            .current-icon-temp::after {
                display: none;
            }
            
            .current-details {
                padding-left: 0;
                grid-template-columns: 1fr;
                gap: 6px;
                padding-right: 10px;
            }
            
            .detail-row {
                padding: 3px 0;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Local on the 10s header -->
        <div class="local-header">
            <div class="local-title">local on the 10's</div>
            <div class="local-subtitle">Your Local Weather Authority</div>
        </div>

        <div class="content">
            <!-- Current Conditions -->
            <div id="current-section" class="weather-section active">
                <div class="section-header">current conditions</div>
                <div class="location-header" id="location-header-current">LOADING...</div>
                <div class="data-panel">
                    <div class="loading">Loading weather data...</div>
                </div>
            </div>

            <!-- Tonight's Forecast -->
            <div id="tonight-forecast-section" class="weather-section">
                <div class="section-header">local forecast</div>
                <div class="location-header" id="location-header-tonight">LOADING...</div>
                <div class="data-panel">
                    <div class="text-forecast" id="tonight-forecast"></div>
                </div>
            </div>

            <!-- Tomorrow's Forecast -->
            <div id="tomorrow-forecast-section" class="weather-section">
                <div class="section-header">local forecast</div>
                <div class="location-header" id="location-header-tomorrow">LOADING...</div>
                <div class="data-panel">
                    <div class="text-forecast" id="tomorrow-forecast"></div>
                </div>
            </div>

            <!-- 7-Day Forecast -->
            <div id="forecast-section" class="weather-section">
                <div class="section-header">the week ahead</div>
                <div class="location-header" id="location-header-forecast">LOADING...</div>
                <div class="data-panel">
                    <div class="forecast-grid" id="forecast-grid"></div>
                </div>
            </div>

            <!-- Local Radar -->
            <div id="local-radar-section" class="weather-section radar-fullscreen">
                <div class="local-header">
                    <div class="radar-banner-row1">
                        <div class="radar-banner-title">local on the 10's - your local weather authority</div>
                    </div>
                    <div class="radar-banner-row2">
                        <div class="section-header">local radar</div>
                        <div class="location-header" id="location-header-local-radar">LOADING...</div>
                    </div>
                </div>
                <div class="data-panel">
                    <div class="radar-container">
                        <div class="radar-loading" id="local-radar-loading">Loading radar...</div>
                        <div id="local-radar-map" class="radar-map"></div>
                        <div id="local-radar-timestamp" class="radar-timestamp"></div>
                    </div>
                </div>
            </div>

            <!-- Regional Radar -->
            <div id="regional-radar-section" class="weather-section radar-fullscreen">
                <div class="local-header">
                    <div class="radar-banner-row1">
                        <div class="radar-banner-title">local on the 10's - your local weather authority</div>
                    </div>
                    <div class="radar-banner-row2">
                        <div class="section-header">regional radar</div>
                        <div class="location-header" id="location-header-regional-radar">LOADING...</div>
                    </div>
                </div>
                <div class="data-panel">
                    <div class="radar-container">
                        <div class="radar-loading" id="regional-radar-loading">Loading radar...</div>
                        <div id="regional-radar-map" class="radar-map"></div>
                        <div id="regional-radar-timestamp" class="radar-timestamp"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer-bar">
            <div class="footer-left">
                <span class="current-location" id="footer-location">ROCKLAND</span>
                <span class="current-temp-small" id="footer-temp">19°</span>
            </div>
            <div class="footer-center">
                <div class="time-display" id="date-display">TUE OCT 07</div>
                <div class="time-display" id="time-display">3:39 PM</div>
                <div class="time-display sun-display-large" id="sun-display">☀️ 6:45↑ 6:32↓</div>
                <div class="moon-display moon-display-large" id="moon-display">🌙 --</div>
            </div>
            <div class="twc-logo">LOCAL<br>WEATHER</div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
    console.log('🔄 Local on the 10s - Version 4.0.1 - Fixed Sun/Moon Display');
    
    // Configuration
    let config = {
        location_name: "Home",
    display_name: "LOCAL AREA",
    region_name: "",
    weather_entity: null,
    display_duration: 10,
    latitude: null,
    longitude: null
    };

        // Background images array
    const BACKGROUNDS = [
        '/local_on_the_10s/backgrounds/clouds%20at%20dusk.jpg',
    '/local_on_the_10s/backgrounds/dark%20clouds%20evening%20time.jpg'
    ];

        let currentBackgroundIndex = 0;
    let localRadarMap = null;
    let regionalRadarMap = null;
    let radarFrames = [];
    let radarAnimationFrame = 0;
    let radarAnimationInterval = null;

        // Set background image
    function setBackgroundImage(index) {
        const bgIndex = index % BACKGROUNDS.length;
    document.body.style.setProperty('--bg-image', `url('${BACKGROUNDS[bgIndex]}')`);  
    }

        // Update background when section changes
    function updateBackground() {
        currentBackgroundIndex = (currentBackgroundIndex + 1) % BACKGROUNDS.length;
    setBackgroundImage(currentBackgroundIndex);
    }

        // Get the base path for assets
    const ASSETS_PATH = '/local_on_the_10s/assets/svg';

        // Map Home Assistant conditions to Weather Channel icon filenames
    function getWeatherIconPath(condition, isNight = false) {
        const iconMap = {
        'clear-night': 'Fair-Mostly Clear (night).png',
    'cloudy': 'Cloudy.png',
    'fog': 'Foggy Conditions.png',
    'hail': 'Sleet.png',
    'lightning': 'Thunderstorms.png',
    'lightning-rainy': 'Thunderstorms.png',
    'partlycloudy': isNight ? 'Partly Cloudy (night).png' : 'Partly Cloudy (day).png',
    'pouring': 'Heavy Rain and Wind.png',
    'rainy': 'Rain.png',
    'snowy': 'Snow.png',
    'snowy-rainy': 'Rain and Snow.png',
    'sunny': 'Sunny.png',
    'windy': 'Windy Conditions.png',
    'windy-variant': 'Clear and Windy.png',
    'exceptional': 'Not Available.png'
    };
    
    const filename = iconMap[condition] || 'Sunny.png';
    return `${ASSETS_PATH}/${encodeURIComponent(filename)}`;
    }

        function getWeatherIcon(condition, isNight = false) {
        const iconPath = getWeatherIconPath(condition, isNight);
    return `<img src="${iconPath}" alt="${condition}" style="width: 100%; height: 100%; object-fit: contain;" onerror="this.style.display='none'; this.parentElement.innerHTML='<div style=\\'font-size:64px;\\'>${getIconFallback(condition)}</div>'">`;
    }

        // Fallback emoji icons if PNG fails to load
    function getIconFallback(condition) {
        const fallbacks = {
        'clear-night': '🌙',
    'cloudy': '☁️',
    'fog': '🌫️',
    'hail': '🧊',
    'lightning': '⚡',
    'lightning-rainy': '⛈️',
    'partlycloudy': '⛅',
    'pouring': '🌧️',
    'rainy': '🌦️',
    'snowy': '❄️',
    'snowy-rainy': '🌨️',
    'sunny': '☀️',
    'windy': '💨',
    'windy-variant': '🌬️',
    'exceptional': '⚠️'
    };
    return fallbacks[condition] || '🌤️';
    }

        let currentSectionIndex = 0;
    //const sections = ['tonight-forecast'];
    const sections = ['current', 'tonight-forecast', 'tomorrow-forecast', 'forecast', 'local-radar', 'regional-radar'];
    let weatherData = null;
    let forecastData = null;

        console.log('📋 Section rotation order:', sections);

        // Get config ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const configId = urlParams.get('config_id');
    
        console.log('📋 Config ID for dashboard card:', configId || 'Not found in URL');

        // Initialize radar maps
        function initializeRadarMaps() {
            if (!config.latitude || !config.longitude) {
                console.error('No location coordinates available');
                return;
            }

            console.log(`📍 Initializing radar at: ${config.latitude}, ${config.longitude}`);

            // Local radar - 50 mile radius (zoom level ~9)
            if (!localRadarMap) {
                localRadarMap = L.map('local-radar-map', {
                    center: [config.latitude, config.longitude],
                    zoom: 9,
                    zoomControl: false,
                    attributionControl: false,
                    dragging: false,
                    scrollWheelZoom: false,
                    doubleClickZoom: false,
                    touchZoom: false
                });

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    opacity: 0.5,
                    maxZoom: 12
                }).addTo(localRadarMap);

                // Add location marker
                L.marker([config.latitude, config.longitude], {
                    icon: L.divIcon({
                        className: 'custom-marker',
                        html: '<div style="background: red; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white;"></div>',
                        iconSize: [12, 12]
                    })
                }).addTo(localRadarMap);
            }

            // Regional radar - 150 mile radius (zoom level ~7)
            if (!regionalRadarMap) {
                regionalRadarMap = L.map('regional-radar-map', {
                    center: [config.latitude, config.longitude],
                    zoom: 7,
                    zoomControl: false,
                    attributionControl: false,
                    dragging: false,
                    scrollWheelZoom: false,
                    doubleClickZoom: false,
                    touchZoom: false
                });

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    opacity: 0.5,
                    maxZoom: 12
                }).addTo(regionalRadarMap);

                // Add location marker
                L.marker([config.latitude, config.longitude], {
                    icon: L.divIcon({
                        className: 'custom-marker',
                        html: '<div style="background: red; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white;"></div>',
                        iconSize: [12, 12]
                    })
                }).addTo(regionalRadarMap);
            }

            loadRadarData();
        }

        // Load RainViewer radar data
        async function loadRadarData() {
            try {
                console.log('📡 Fetching RainViewer radar data...');
                document.getElementById('local-radar-loading').style.display = 'block';
                document.getElementById('regional-radar-loading').style.display = 'block';
                
                const response = await fetch('https://api.rainviewer.com/public/weather-maps.json');
                const data = await response.json();
                
                // Only use past frames (no forecast/nowcast)
                radarFrames = data.radar.past.slice(-6); // Last 6 past frames only
                console.log(`📡 Loaded ${radarFrames.length} past radar frames (no forecast)`);
                console.log(`📡 First frame path: ${radarFrames[0]?.path}`);
                
                // Hide loading indicators
                document.getElementById('local-radar-loading').style.display = 'none';
                document.getElementById('regional-radar-loading').style.display = 'none';
                
                startRadarAnimation();
            } catch (error) {
                console.error('❌ Error loading radar data:', error);
                document.getElementById('local-radar-loading').textContent = 'Radar unavailable';
                document.getElementById('regional-radar-loading').textContent = 'Radar unavailable';
            }
        }

        let localRadarLayer = null;
        let regionalRadarLayer = null;
        let localRadarLayers = [];
        let regionalRadarLayers = [];

        function formatRadarTimestamp(timestamp) {
            const date = new Date(timestamp * 1000);
            const now = new Date();
            const diffMinutes = Math.round((now - date) / 60000);
            
            const timeStr = date.toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit'
            });
            
            if (diffMinutes === 0) {
                return `${timeStr} (Now)`;
            } else {
                return `${timeStr} (${diffMinutes} min ago)`;
            }
        }

        function startRadarAnimation() {
            if (radarAnimationInterval) {
                clearInterval(radarAnimationInterval);
            }

            radarAnimationFrame = 0;
            let playCount = 0;
            
            radarAnimationInterval = setInterval(() => {
                if (radarFrames.length === 0) return;
                
                const frame = radarFrames[radarAnimationFrame];
                // Use standard 256px tiles with color scheme 6 (enhanced) and smoothing
                const radarTileUrl = `https://tilecache.rainviewer.com${frame.path}/256/{z}/{x}/{y}/6/1_1.png`;
                
                const timestamp = formatRadarTimestamp(frame.time);
                console.log(`🎬 Frame ${radarAnimationFrame}/${radarFrames.length - 1}: ${timestamp}`);
                
                // Update timestamps
                const localTimestamp = document.getElementById('local-radar-timestamp');
                const regionalTimestamp = document.getElementById('regional-radar-timestamp');
                if (localTimestamp) localTimestamp.textContent = timestamp;
                if (regionalTimestamp) regionalTimestamp.textContent = timestamp;
                
                // Update local radar
                if (localRadarMap) {
                    // Remove old layer immediately
                    if (localRadarLayer) {
                        localRadarMap.removeLayer(localRadarLayer);
                    }
                    
                    // Add new layer
                    localRadarLayer = L.tileLayer(radarTileUrl, {
                        opacity: 0.6,
                        zIndex: 10,
                        maxZoom: 12,
                        crossOrigin: true
                    }).addTo(localRadarMap);
                }
                
                // Update regional radar
                if (regionalRadarMap) {
                    // Remove old layer immediately
                    if (regionalRadarLayer) {
                        regionalRadarMap.removeLayer(regionalRadarLayer);
                    }
                    
                    // Add new layer
                    regionalRadarLayer = L.tileLayer(radarTileUrl, {
                        opacity: 0.6,
                        zIndex: 10,
                        maxZoom: 12,
                        crossOrigin: true
                    }).addTo(regionalRadarMap);
                }
                
                radarAnimationFrame++;
                
                // Stop after one complete loop
                if (radarAnimationFrame >= radarFrames.length) {
                    radarAnimationFrame = radarFrames.length - 1; // Stay on last frame
                    clearInterval(radarAnimationInterval);
                    console.log('✅ Radar animation complete - showing current frame');
                }
            }, 1000); // 1 second per frame
        }

        // Load configuration
        async function loadConfig() {
            if (!configId) {
                console.error('No config ID provided');
                return;
            }

            try {
                const tokenStr = window.parent.localStorage.getItem('hassTokens');
                if (!tokenStr) {
                    console.error('No Home Assistant token found');
                    return;
                }

                const tokens = JSON.parse(tokenStr);
                const response = await fetch(`/api/local_on_the_10s/config/${configId}`, {
                    headers: {
                        'Authorization': `Bearer ${tokens.access_token}`,
                        'Content-Type': 'application/json',
                    }
                });

                if (response.ok) {
                    config = await response.json();
                    updateLocationHeaders();
                    await fetchWeather(); // Wait for weather data to get location
                }
            } catch (error) {
                console.error('Error loading config:', error);
            }
        }

        // Update all location headers
        function updateLocationHeaders() {
            const headers = document.querySelectorAll('[id^="location-header"]');
            headers.forEach(header => {
                header.textContent = config.display_name;
            });
            
            document.getElementById('footer-location').textContent = 
                config.region_name || config.display_name;
        }

        // Update time and date display
        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit'
            });
            document.getElementById('time-display').textContent = timeString;
            
            const dateString = now.toLocaleDateString('en-US', { 
                weekday: 'short', 
                month: 'short', 
                day: '2-digit' 
            }).toUpperCase();
            document.getElementById('date-display').textContent = dateString;
        }
        
        // Update sunrise/sunset display  
        function updateSunTimes() {
            if (!weatherData || !weatherData.attributes) return;
            
            const attr = weatherData.attributes;
            const sunDisplay = document.getElementById('sun-display');
            
            if (attr.sun_next_rising && attr.sun_next_setting) {
                const sunrise = new Date(attr.sun_next_rising);
                const sunset = new Date(attr.sun_next_setting);
                
                const sunriseTime = sunrise.toLocaleTimeString('en-US', { 
                    hour: 'numeric', 
                    minute: '2-digit',
                    hour12: false
                }).replace(/^0/, '');
                
                const sunsetTime = sunset.toLocaleTimeString('en-US', { 
                    hour: 'numeric', 
                    minute: '2-digit',
                    hour12: false
                }).replace(/^0/, '');
                
                sunDisplay.textContent = `☀️ ${sunriseTime}↑ ${sunsetTime}↓`;
            }
        }

        // Fetch weather data
        async function fetchWeather() {
            try {
                const tokenStr = window.parent.localStorage.getItem('hassTokens');
                if (!tokenStr) return;

                const tokens = JSON.parse(tokenStr);
                
                const response = await fetch('/api/states', {
                    headers: {
                        'Authorization': `Bearer ${tokens.access_token}`,
                        'Content-Type': 'application/json',
                    }
                });

                const states = await response.json();
                weatherData = states.find(entity => 
                    entity.entity_id === config.weather_entity
                );

                // Get coordinates from weather entity or HA config
                if (weatherData && weatherData.attributes) {
                    // Try to get from weather entity attributes first
                    config.latitude = weatherData.attributes.latitude || config.latitude;
                    config.longitude = weatherData.attributes.longitude || config.longitude;
                }
                
                // If still no coordinates, get from HA config
                if (!config.latitude || !config.longitude) {
                    try {
                        const haConfigResponse = await fetch('/api/config', {
                            headers: {
                                'Authorization': `Bearer ${tokens.access_token}`,
                                'Content-Type': 'application/json',
                            }
                        });
                        
                        if (haConfigResponse.ok) {
                            const haConfig = await haConfigResponse.json();
                            config.latitude = config.latitude || haConfig.latitude;
                            config.longitude = config.longitude || haConfig.longitude;
                        }
                    } catch (err) {
                        console.error('Error fetching HA config:', err);
                    }
                }
                
                console.log(`📍 Location set to: ${config.latitude}, ${config.longitude}`);
                
                // Initialize radar with location
                if (config.latitude && config.longitude && !localRadarMap && !regionalRadarMap) {
                    initializeRadarMaps();
                }

                if (config.weather_entity) {
                    try {
                        const forecastResponse = await fetch('/api/services/weather/get_forecasts?return_response', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${tokens.access_token}`,
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                entity_id: config.weather_entity,
                                type: 'daily'
                            })
                        });

                        if (forecastResponse.ok) {
                            const forecastResult = await forecastResponse.json();
                            if (forecastResult && forecastResult.service_response && 
                                forecastResult.service_response[config.weather_entity]) {
                                forecastData = forecastResult.service_response[config.weather_entity].forecast;
                            }
                        }
                    } catch (err) {
                        console.error('Error fetching forecasts:', err);
                    }
                }

                if (weatherData) {
                    updateDisplay();
                    updateSunTimes();
                }
            } catch (error) {
                console.error('Error fetching weather:', error);
            }
        }

        // Update the weather display
        function updateDisplay() {
            if (!weatherData) return;

            const attr = weatherData.attributes;
            
            updateCurrentConditions(attr);
            
            if (forecastData && forecastData.length > 0) {
                updateForecast({ forecast: forecastData });
                updateTonightForecast({ ...attr, forecast: forecastData });
                updateTomorrowForecast({ ...attr, forecast: forecastData });
            } else if (attr.forecast && attr.forecast.length > 0) {
                updateForecast(attr);
                updateTonightForecast(attr);
                updateTomorrowForecast(attr);
            }
            
            document.getElementById('footer-temp').textContent = 
                `${Math.round(attr.temperature)}°`;
        }

        function updateCurrentConditions(attr) {
            const section = document.getElementById('current-section').querySelector('.data-panel');
            
            const hour = new Date().getHours();
            const isNight = hour >= 19 || hour < 6;
            
            const iconHtml = getWeatherIcon(weatherData.state, isNight);
            
            const html = `
                <div class="current-layout">
                    <div class="current-icon-temp">
                        <div class="weather-icon-large">${iconHtml}</div>
                        <div class="condition-text">${formatCondition(weatherData.state)}</div>
                        <div class="temp-large">${Math.round(attr.temperature)}</div>
                    </div>
                    <div class="current-details">
                        <div class="detail-row">
                            <span class="detail-label">HUMIDITY</span>
                            <span class="detail-value">${attr.humidity}%</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">DEW POINT</span>
                            <span class="detail-value">${attr.dew_point ? Math.round(attr.dew_point) + '°' : 'N/A'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">PRESSURE</span>
                            <span class="detail-value">${formatPressure(attr)}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">VISIBILITY</span>
                            <span class="detail-value">${formatVisibility(attr)}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">WIND</span>
                            <span class="detail-value">${formatWind(attr)}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">GUSTS</span>
                            <span class="detail-value">${formatGusts(attr)}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">UV INDEX</span>
                            <span class="detail-value">${formatUVIndex(attr)}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">FEELS LIKE</span>
                            <span class="detail-value">${formatFeelsLike(attr)}</span>
                        </div>
                    </div>
                </div>
            `;
            
            section.innerHTML = html;
        }

        function updateForecast(attr) {
            if (!attr.forecast || attr.forecast.length === 0) {
                document.getElementById('forecast-grid').innerHTML = 
                    '<div style="grid-column: 1/-1; text-align: center; padding: 40px; font-size: 22px;">No forecast data available</div>';
                return;
            }
            
            const container = document.getElementById('forecast-grid');
            const html = attr.forecast.slice(0, 7).map(day => {
                const date = new Date(day.datetime);
                const dayName = date.toLocaleDateString('en-US', { weekday: 'short' }).toUpperCase();
                
                const highTemp = day.temperature !== undefined ? Math.round(day.temperature) : '--';
                const lowTemp = day.templow !== undefined ? Math.round(day.templow) : '--';
                
                const iconHtml = getWeatherIcon(day.condition, false);
                
                return `
                    <div class="forecast-card">
                        <div class="forecast-day">${dayName}</div>
                        <div class="forecast-icon">${iconHtml}</div>
                        <div class="forecast-condition">${formatCondition(day.condition)}</div>
                        <div class="forecast-temps">
                            <span class="temp-high">${highTemp}°</span>
                            <br>
                            <span class="temp-low">${lowTemp}°</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }

        function updateTonightForecast(attr) {
            const container = document.getElementById('tonight-forecast');
            let text = '';
            
            if (attr.forecast && attr.forecast.length >= 1) {
                const today = attr.forecast[0];
                
                const hour = new Date().getHours();
                const isNight = hour >= 18 || hour < 6;
                
                const tonightTemp = today.templow !== undefined ? Math.round(today.templow) : '--';
                const tonightCondition = formatCondition(today.condition);
                
                text = `
                    <div class="forecast-period">${isNight ? 'Tonight' : 'This Evening'}</div>
                    <p>${tonightCondition}. Low ${tonightTemp}°. 
                    Winds ${formatWindDirection(attr.wind_bearing)} at ${Math.round(attr.wind_speed)} ${attr.wind_speed_unit || 'km/h'}.</p>
                `;
            } else {
                text = '<div style="padding: 20px; text-align: center;">Tonight\'s forecast information not available</div>';
            }
            
            container.innerHTML = text;
        }
        
        function updateTomorrowForecast(attr) {
            const container = document.getElementById('tomorrow-forecast');
            let text = '';
            
            if (attr.forecast && attr.forecast.length >= 2) {
                const tomorrow = attr.forecast[1];
                
                const tomorrowHigh = tomorrow.temperature !== undefined ? Math.round(tomorrow.temperature) : '--';
                const tomorrowLow = tomorrow.templow !== undefined ? Math.round(tomorrow.templow) : '--';
                const tomorrowCondition = formatCondition(tomorrow.condition);
                const precipChance = tomorrow.precipitation_probability !== undefined ? tomorrow.precipitation_probability : null;
                
                text = `
                    <div class="forecast-period">Tomorrow</div>
                    <p>${tomorrowCondition}. High ${tomorrowHigh}°. Low ${tomorrowLow}°. ${precipChance !== null ? `Chance of precipitation ${precipChance}%.` : ''}</p>
                `;
            } else {
                text = '<div style="padding: 20px; text-align: center;">Tomorrow\'s forecast information not available</div>';
            }
            
            container.innerHTML = text;
        }

        function formatCondition(condition) {
            if (!condition) return 'Unknown';
            const formatted = condition.split('-').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
            
            return formatted.replace('Partlycloudy', 'Partly Cloudy');
        }
        
        function formatPressure(attr) {
            if (!attr.pressure) return 'N/A';
            const pressure = attr.pressure;
            const unit = attr.pressure_unit || 'hPa';
            
            if (unit === 'hPa' || unit === 'mbar') {
                const inches = (pressure * 0.02953).toFixed(2);
                return `${inches} inches`;
            }
            return `${pressure} ${unit}`;
        }
        
        function formatVisibility(attr) {
            if (!attr.visibility) return 'N/A';
            const vis = attr.visibility;
            const unit = attr.visibility_unit || 'km';
            
            if (unit === 'km') {
                const miles = (vis * 0.621371).toFixed(0);
                return `${miles} miles`;
            }
            return `${vis} ${unit}`;
        }
        
        function formatWind(attr) {
            if (!attr.wind_speed) return 'Calm';
            const speed = Math.round(attr.wind_speed);
            const direction = formatWindDirection(attr.wind_bearing);
            return `${direction} ${speed}`;
        }
        
        function formatGusts(attr) {
            if (!attr.wind_gust_speed) return 'None';
            const speed = Math.round(attr.wind_gust_speed);
            return `${speed}`;
        }
        
        function formatUVIndex(attr) {
            if (attr.uv_index === undefined || attr.uv_index === null) return 'N/A';
            const uv = Math.round(attr.uv_index);
            let description = '';
            if (uv <= 2) description = ' Low';
            else if (uv <= 5) description = ' Mod';
            else if (uv <= 7) description = ' High';
            else if (uv <= 10) description = ' V.High';
            else description = ' Extreme';
            return `${uv}${description}`;
        }
        
        function formatFeelsLike(attr) {
            // Check for apparent_temperature (feels like)
            if (attr.apparent_temperature !== undefined && attr.apparent_temperature !== null) {
                return `${Math.round(attr.apparent_temperature)}°`;
            }
            // Fallback to calculating heat index or wind chill
            const temp = attr.temperature;
            const humidity = attr.humidity;
            
            if (temp >= 27) { // 80°F or higher - calculate heat index
                const hi = -8.78469475556 + 
                          1.61139411 * temp + 
                          2.33854883889 * humidity + 
                          -0.14611605 * temp * humidity + 
                          -0.012308094 * temp * temp + 
                          -0.0164248277778 * humidity * humidity + 
                          0.002211732 * temp * temp * humidity + 
                          0.00072546 * temp * humidity * humidity + 
                          -0.000003582 * temp * temp * humidity * humidity;
                return `${Math.round(hi)}°`;
            }
            
            // Otherwise just return actual temp
            return `${Math.round(temp)}°`;
        }
        
        function getMoonPhase() {
            // Calculate moon phase based on current date
            const now = new Date();
            let year = now.getFullYear();
            let month = now.getMonth() + 1;
            const day = now.getDate();
            
            // Simple moon phase calculation
            let c = 0, e = 0, jd = 0, b = 0;
            
            if (month < 3) {
                year--;
                month += 12;
            }
            
            month++;
            c = 365.25 * year;
            e = 30.6 * month;
            jd = c + e + day - 694039.09;
            jd /= 29.5305882;
            b = parseInt(jd);
            jd -= b;
            b = Math.round(jd * 8);
            
            const phases = [
                { emoji: '🌑', name: 'New' },
                { emoji: '🌒', name: 'Waxing Crescent' },
                { emoji: '🌓', name: 'First Quarter' },
                { emoji: '🌔', name: 'Waxing Gibbous' },
                { emoji: '🌕', name: 'Full' },
                { emoji: '🌖', name: 'Waning Gibbous' },
                { emoji: '🌗', name: 'Last Quarter' },
                { emoji: '🌘', name: 'Waning Crescent' }
            ];
            
            const phase = phases[b % 8];
            return `${phase.emoji} ${phase.name}`;
        }
        
        function updateMoonPhase() {
            const moonDisplay = document.getElementById('moon-display');
            if (moonDisplay) {
                moonDisplay.textContent = getMoonPhase();
            }
        }
        
        function formatWindDirection(bearing) {
            if (!bearing && bearing !== 0) return '';
            const directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
            const index = Math.round(bearing / 22.5) % 16;
            return directions[index];
        }

        // Rotate sections
        function rotateSection() {
            const current = document.getElementById(`${sections[currentSectionIndex]}-section`);
            current.classList.remove('active');
            
            currentSectionIndex = (currentSectionIndex + 1) % sections.length;
            
            const next = document.getElementById(`${sections[currentSectionIndex]}-section`);
            next.classList.add('active');
            
            // Hide/show main header based on whether radar is active
            const mainHeader = document.querySelector('#app > .local-header');
            if (mainHeader) {
                if (sections[currentSectionIndex] === 'local-radar' || sections[currentSectionIndex] === 'regional-radar') {
                    mainHeader.style.display = 'none';
                } else {
                    mainHeader.style.display = 'block';
                }
            }
            
            // Adjust content wrapper for radar screens
            const contentDiv = document.querySelector('.content');
            if (contentDiv) {
                if (sections[currentSectionIndex] === 'local-radar' || sections[currentSectionIndex] === 'regional-radar') {
                    contentDiv.style.height = '100%';
                    contentDiv.style.padding = '0';
                } else {
                    contentDiv.style.height = 'calc(100% - 70px)';
                    contentDiv.style.padding = '40px';
                }
            }
            
            console.log(`🔄 Rotated to section: ${sections[currentSectionIndex]}`);
            
            // Refresh radar maps when they become visible and restart animation
            if (sections[currentSectionIndex] === 'local-radar' && localRadarMap) {
                setTimeout(() => {
                    localRadarMap.invalidateSize();
                    startRadarAnimation(); // Restart animation from beginning
                }, 100);
            }
            if (sections[currentSectionIndex] === 'regional-radar' && regionalRadarMap) {
                setTimeout(() => {
                    regionalRadarMap.invalidateSize();
                    startRadarAnimation(); // Restart animation from beginning
                }, 100);
            }
            
            updateBackground();
        }

        // Initialize
        setBackgroundImage(0);
        updateTime();
        updateMoonPhase();
        setInterval(updateTime, 1000);
        setInterval(updateMoonPhase, 3600000); // Update moon phase every hour
        
        loadConfig();
        setInterval(fetchWeather, 300000);
        setInterval(loadRadarData, 600000); // Refresh radar data every 10 minutes
        
        setInterval(() => {
            rotateSection();
        }, (config.display_duration || 10) * 1000);
    </script>
</body>
</html>
