<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local on the 10s</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', 'Helvetica', sans-serif;
            font-weight: bold;
            background: #1a4570;
            overflow: hidden;
            height: 100vh;
            color: white;
            image-rendering: auto;
            position: relative;
        }

        /* Background image layer with rotation */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: var(--bg-image, url('/local_on_the_10s/backgrounds/clouds%20at%20dusk.jpg'));
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            transition: opacity 1s ease-in-out;
            z-index: 0;
        }

        /* Dark overlay on background */
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                /* Scan line overlay */
                repeating-linear-gradient(
                    0deg,
                    rgba(0, 0, 0, 0.15) 0px,
                    transparent 1px,
                    transparent 2px,
                    rgba(0, 0, 0, 0.15) 3px
                ),
                /* Dark gradient overlay */
                linear-gradient(180deg, 
                    rgba(26, 69, 112, 0.75) 0%, 
                    rgba(39, 90, 136, 0.70) 20%,
                    rgba(58, 111, 160, 0.65) 40%,
                    rgba(77, 133, 184, 0.60) 60%,
                    rgba(98, 153, 204, 0.65) 80%,
                    rgba(120, 174, 216, 0.70) 100%);
            pointer-events: none;
            z-index: 1;
        }

        #app {
            width: 100%;
            height: 100vh;
            position: relative;
            z-index: 2;
        }

        /* Film grain overlay for authentic broadcast look */
        #app::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAMAAABHPGVmAAAABlBMVEX///8AAABVwtN+AAABVUlEQVR4nO2YQQ7DIAxE7f0PTYe2qpQgO8ZmRZf5qxDvSQYcjLHW2l9bL6211tpfWy+ttdZaa39tvbT22l9bL6211v7aemmt/bX10lprrf219dL+v9b+2npprb221v7aemlrre219dL+v9b+2npprbW+tl5aa339tfXSWmt9bb201tpfWy+ttb+2Xlpr7a+tl9Zaa39tvbTW/tp6aa21v7ZeWmvtr62X1lr7a+ultdb+2npprb221v7aemlrrfW19dJaa31tvbTW2l9bL6211tpfWy+ttb+2Xlpr7a+tl9Zaa39tvbTW2l9bL6219tfWS2ut/bX10lprrf219dJaa39tvbTW/tp6aa21v7ZeWmvtr62X1lprf229tNZaX1svrb221v7aemlrrfW19dJaa31tvbTW2l9bL621v7ZeWmvtr62X1lr7a+ultdb+2npprb221v7aemlrrbW/tl5aa+2vrZf2BestEXXt5YsaAAAAAElFTkSuQmCC');
            opacity: 0.02;
            pointer-events: none;
            z-index: 999;
            animation: grainAnimate 0.5s steps(3) infinite;
        }

        @keyframes grainAnimate {
            0%, 100% { transform: translate(0, 0); }
            10% { transform: translate(-5%, -5%); }
            20% { transform: translate(-10%, 5%); }
            30% { transform: translate(5%, -10%); }
            40% { transform: translate(-5%, 15%); }
            50% { transform: translate(-10%, 5%); }
            60% { transform: translate(15%, 0); }
            70% { transform: translate(0, 10%); }
            80% { transform: translate(-15%, 0); }
            90% { transform: translate(10%, 5%); }
        }

        /* Animated cloud background - more opaque for 2005 look */
        .clouds {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
            z-index: 1;
            opacity: 0.4;
        }

        .cloud {
            position: absolute;
            background: rgba(255, 255, 255, 0.25);
            border-radius: 100px;
            animation: float 80s linear infinite;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
        }

        .cloud::before,
        .cloud::after {
            content: '';
            position: absolute;
            background: rgba(255, 255, 255, 0.25);
            border-radius: 100px;
        }

        .cloud-1 {
            width: 200px;
            height: 60px;
            top: 15%;
            left: -200px;
            animation-duration: 60s;
        }

        .cloud-1::before { width: 100px; height: 60px; top: -30px; left: 30px; }
        .cloud-1::after { width: 120px; height: 60px; top: -20px; left: 80px; }

        .cloud-2 {
            width: 180px;
            height: 50px;
            top: 60%;
            left: -180px;
            animation-duration: 70s;
            animation-delay: -30s;
        }

        .cloud-2::before { width: 90px; height: 50px; top: -25px; left: 25px; }
        .cloud-2::after { width: 100px; height: 50px; top: -15px; left: 70px; }

        @keyframes float {
            from { transform: translateX(0); }
            to { transform: translateX(calc(100vw + 250px)); }
        }

        /* Main content */
        .content {
            position: relative;
            z-index: 10;
            height: calc(100% - 70px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }

        /* Section header - 2005 broadcast style */
        .section-header {
            background: 
                linear-gradient(180deg, 
                    rgba(35, 55, 75, 0.85) 0%, 
                    rgba(25, 40, 60, 0.90) 50%,
                    rgba(18, 30, 48, 0.92) 100%);
            padding: 8px 30px;
            font-size: 32px;
            font-weight: normal;
            text-transform: lowercase;
            margin-bottom: 0;
            text-shadow: 
                0 0 8px rgba(255, 255, 255, 0.4),
                2px 2px 4px rgba(0, 0, 0, 0.9),
                0 0 12px rgba(255, 255, 255, 0.2);
            letter-spacing: 1px;
            width: 100%;
            max-width: 950px;
            border-top-left-radius: 6px;
            border-top-right-radius: 6px;
            border: 1px solid rgba(80, 120, 160, 0.4);
            border-bottom: none;
            box-shadow: 
                0 3px 8px rgba(0, 0, 0, 0.8),
                inset 0 1px 0 rgba(255, 255, 255, 0.1),
                0 0 20px rgba(0, 0, 0, 0.3);
            filter: blur(0.3px);
        }

        /* Weather panels */
        .weather-section {
            position: absolute;
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 60px 40px 90px;
        }

        .weather-section.active {
            display: flex;
            animation: fadeIn 0.8s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Location header bar - 2005 glossy gel style */
        .location-header {
            background: 
                /* Glossy highlight */
                linear-gradient(180deg, 
                    rgba(255, 255, 255, 0.25) 0%,
                    rgba(255, 255, 255, 0) 50%),
                /* Main gradient */
                linear-gradient(180deg, 
                    #d8f050 0%, 
                    #c8e048 15%,
                    #b0cc38 40%,
                    #98b828 70%,
                    #80a020 100%);
            padding: 13px 30px;
            font-size: 30px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 3px;
            box-shadow: 
                0 5px 15px rgba(0, 0, 0, 0.7),
                inset 0 3px 0 rgba(255, 255, 255, 0.4),
                inset 0 -3px 0 rgba(0, 0, 0, 0.4),
                0 0 30px rgba(0, 0, 0, 0.4);
            margin-bottom: 0;
            width: 100%;
            max-width: 950px;
            text-align: center;
            color: white;
            text-shadow: 
                0 0 10px rgba(255, 255, 255, 0.5),
                2px 2px 3px rgba(0, 0, 0, 0.8),
                0 0 15px rgba(200, 220, 80, 0.6);
            border-left: 1px solid rgba(0, 0, 0, 0.6);
            border-right: 1px solid rgba(0, 0, 0, 0.6);
            position: relative;
            filter: blur(0.3px);
        }

        /* Data panel - 2005 glossy broadcast style */
        .data-panel {
            background: 
                /* Glass highlight */
                linear-gradient(180deg, 
                    rgba(120, 160, 200, 0.15) 0%,
                    rgba(80, 120, 180, 0) 30%),
                /* Main gradient */
                linear-gradient(180deg, 
                    rgba(45, 80, 135, 0.88) 0%,
                    rgba(38, 68, 118, 0.90) 40%,
                    rgba(32, 58, 105, 0.92) 70%,
                    rgba(28, 50, 92, 0.94) 100%);
            border: 1px solid rgba(70, 110, 150, 0.5);
            border-top: 2px solid rgba(90, 130, 180, 0.4);
            box-shadow: 
                0 10px 25px rgba(0, 0, 0, 0.8),
                inset 0 2px 0 rgba(150, 190, 230, 0.2),
                inset 0 -2px 8px rgba(0, 0, 0, 0.4),
                0 0 40px rgba(0, 0, 0, 0.5);
            padding: 40px;
            width: 100%;
            max-width: 950px;
            border-bottom-left-radius: 6px;
            border-bottom-right-radius: 6px;
            position: relative;
            filter: blur(0.3px);
        }

        /* Heavy noise texture overlay for broadcast look */
        .data-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwBAMAAAClLOS0AAAAElBMVEUAAAAAAAAAAAAAAAAAAAAAAADgKxmiAAAABnRSTlMCCwwNDhGXV8FhAAAAPklEQVQ4y2NgAAOGIJCBESBiABFMAFEMIAIMAAEQxQgQxQQQBREMIEVMQFFMAFEQwQhSBBYFKwIrYoRrAgkCAKSzBTcnN4TpAAAAAElFTkSuQmCC');
            opacity: 0.08;
            pointer-events: none;
            border-radius: inherit;
        }

        /* Additional glass reflection effect */
        .data-panel::after {
            content: '';
            position: absolute;
            top: 0;
            left: 5%;
            right: 5%;
            height: 40%;
            background: linear-gradient(180deg, 
                rgba(255, 255, 255, 0.08) 0%,
                rgba(255, 255, 255, 0.04) 50%,
                transparent 100%);
            pointer-events: none;
            border-radius: inherit;
        }

        /* Current Conditions Layout - 2005 TWO COLUMN */
        .current-layout {
            display: grid;
            grid-template-columns: 340px 1fr;
            gap: 45px;
            align-items: stretch;
            min-height: 350px;
        }

        /* LEFT PANEL - Icon and Temperature */
        .current-icon-temp {
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-right: 3px solid rgba(80, 120, 180, 0.4);
            padding-right: 35px;
            position: relative;
        }

        /* Add subtle vertical gradient to divider */
        .current-icon-temp::after {
            content: '';
            position: absolute;
            right: -3px;
            top: 10%;
            bottom: 10%;
            width: 1px;
            background: linear-gradient(180deg, 
                transparent 0%,
                rgba(120, 160, 210, 0.5) 50%,
                transparent 100%);
        }

        .weather-icon-large {
            width: 160px;
            height: 160px;
            margin: 0 auto 18px;
            filter: 
                drop-shadow(0 6px 12px rgba(0, 0, 0, 0.6))
                drop-shadow(0 0 20px rgba(255, 255, 255, 0.2));
        }

        .condition-text {
            font-size: 28px;
            margin: 18px 0 28px;
            font-weight: bold;
            letter-spacing: 1px;
            text-shadow: 
                2px 2px 4px rgba(0, 0, 0, 0.8),
                0 0 10px rgba(0, 0, 0, 0.5);
        }

        .temp-large {
            font-size: 140px;
            font-weight: bold;
            line-height: 0.85;
            text-shadow: 
                4px 4px 8px rgba(0, 0, 0, 0.8),
                0 0 20px rgba(255, 255, 255, 0.3);
            letter-spacing: -8px;
            font-family: Arial, Helvetica, sans-serif;
        }

        /* RIGHT PANEL - Details Grid */
        .current-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px 40px;
            padding-left: 25px;
            align-content: center;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
        }

        .detail-label {
            text-transform: uppercase;
            font-weight: bold;
            font-size: 20px;
            letter-spacing: 1.2px;
            color: #a8c8e8;
            text-shadow: 
                1px 1px 2px rgba(0, 0, 0, 0.8);
        }

        .detail-value {
            font-weight: bold;
            text-align: right;
            font-size: 26px;
            letter-spacing: 0.3px;
            text-shadow: 
                2px 2px 3px rgba(0, 0, 0, 0.8);
            font-family: Arial, Helvetica, sans-serif;
            color: #ffffff;
        }

        /* Forecast Grid */
        .forecast-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 14px;
        }

        .forecast-card {
            background: linear-gradient(180deg, 
                rgba(55, 100, 165, 0.75) 0%,
                rgba(45, 85, 145, 0.75) 100%);
            padding: 20px 10px;
            text-align: center;
            border: 1px solid rgba(70, 110, 170, 0.5);
            border-radius: 3px;
            box-shadow: 
                0 3px 6px rgba(0, 0, 0, 0.5),
                inset 0 1px 0 rgba(100, 150, 210, 0.2);
        }

        .forecast-day {
            font-size: 22px;
            font-weight: bold;
            text-transform: uppercase;
            margin-bottom: 15px;
            letter-spacing: 0.8px;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.8);
        }

        .forecast-icon {
            width: 64px;
            height: 64px;
            margin: 18px auto;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.6));
        }

        .forecast-condition {
            font-size: 15px;
            margin: 10px 0;
            line-height: 1.3;
            min-height: 45px;
            font-weight: normal;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }

        .forecast-temps {
            font-size: 34px;
            font-weight: bold;
            margin-top: 10px;
            line-height: 1.1;
            text-shadow: 2px 2px 3px rgba(0, 0, 0, 0.8);
        }

        .temp-high {
            color: #ffffff;
        }

        .temp-low {
            color: #b3e5fc;
        }

        /* Text forecast */
        .text-forecast {
            font-size: 22px;
            line-height: 1.6;
            text-align: left;
            max-width: 850px;
            margin: 0 auto;
            font-weight: normal;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
            color: #e8f0f8;
        }

        .forecast-period {
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 26px;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.8);
            color: #5fc4d4;
        }

        .text-forecast p {
            margin-bottom: 28px;
        }

        /* Regional map placeholder */
        .regional-map {
            background: linear-gradient(135deg, 
                rgba(80, 100, 90, 0.6) 0%,
                rgba(100, 120, 110, 0.5) 100%);
            padding: 60px;
            text-align: center;
            font-size: 22px;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid rgba(120, 140, 130, 0.5);
            border-radius: 4px;
            box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.4);
        }

        /* Footer info bar - 2005 style */
        .footer-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(180deg, 
                rgba(20, 35, 50, 0.92) 0%,
                rgba(15, 25, 40, 0.95) 100%);
            padding: 18px 45px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 24px;
            z-index: 100;
            box-shadow: 
                0 -4px 15px rgba(0, 0, 0, 0.6),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            border-top: 2px solid rgba(60, 90, 120, 0.4);
        }

        .footer-left {
            display: flex;
            align-items: center;
            gap: 18px;
        }

        .current-location {
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        .current-temp-small {
            font-weight: bold;
            font-size: 28px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        .time-display {
            font-weight: bold;
            font-size: 28px;
            letter-spacing: 1px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        .twc-logo {
            background: linear-gradient(180deg, 
                #0077dd 0%,
                #0066cc 50%,
                #0055aa 100%);
            padding: 11px 18px;
            border-radius: 5px;
            font-weight: bold;
            font-size: 11px;
            letter-spacing: 0.8px;
            line-height: 1.4;
            text-align: center;
            box-shadow: 
                0 3px 8px rgba(0, 0, 0, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.25),
                inset 0 -1px 0 rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 100, 200, 0.6);
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        /* Loading */
        .loading {
            font-size: 28px;
            text-align: center;
            padding: 40px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="clouds">
            <div class="cloud cloud-1"></div>
            <div class="cloud cloud-2"></div>
        </div>

        <div class="content">
            <!-- Current Conditions -->
            <div id="current-section" class="weather-section active">
                <div class="section-header">current conditions</div>
                <div class="location-header" id="location-header-current">LOADING...</div>
                <div class="data-panel">
                    <div class="loading">Loading weather data...</div>
                </div>
            </div>

            <!-- Forecast -->
            <div id="forecast-section" class="weather-section">
                <div class="section-header">the week ahead</div>
                <div class="location-header" id="location-header-forecast">LOADING...</div>
                <div class="data-panel">
                    <div class="forecast-grid" id="forecast-grid"></div>
                </div>
            </div>

            <!-- Local Forecast Text -->
            <div id="text-forecast-section" class="weather-section">
                <div class="section-header">local forecast</div>
                <div class="location-header" id="location-header-text">LOADING...</div>
                <div class="data-panel">
                    <div class="text-forecast" id="text-forecast"></div>
                </div>
            </div>

            <!-- Regional Map placeholder -->
            <div id="regional-section" class="weather-section">
                <div class="section-header">regional conditions</div>
                <div class="location-header" id="location-header-regional">LOADING...</div>
                <div class="data-panel">
                    <div class="regional-map">
                        Regional weather map<br>(Requires additional configuration)
                    </div>
                </div>
            </div>
        </div>

        <div class="footer-bar">
            <div class="footer-left">
                <span class="current-location" id="footer-location">ROCKLAND</span>
                <span class="current-temp-small" id="footer-temp">19Â°</span>
            </div>
            <div class="time-display" id="time-display">3:39 PM</div>
            <div class="twc-logo">LOCAL<br>WEATHER</div>
        </div>
    </div>

    <script>
        // Configuration
        let config = {
            location_name: "Home",
            display_name: "LOCAL AREA",
            region_name: "",
            weather_entity: null,
            display_duration: 10
        };

        // Background images array
        const BACKGROUNDS = [
            '/local_on_the_10s/backgrounds/clouds%20at%20dusk.jpg',
            '/local_on_the_10s/backgrounds/dark%20clouds%20evening%20time.jpg'
        ];

        let currentBackgroundIndex = 0;

        // Set background image
        function setBackgroundImage(index) {
            const bgIndex = index % BACKGROUNDS.length;
            document.body.style.setProperty('--bg-image', `url('${BACKGROUNDS[bgIndex]}')`);
        }

        // Update background when section changes
        function updateBackground() {
            currentBackgroundIndex = (currentBackgroundIndex + 1) % BACKGROUNDS.length;
            setBackgroundImage(currentBackgroundIndex);
        }

        // Get the base path for assets - use the registered static path
        const ASSETS_PATH = '/local_on_the_10s/assets/svg';

        // Map Home Assistant conditions to Weather Channel icon filenames
        function getWeatherIconPath(condition, isNight = false) {
            const iconMap = {
                'clear-night': 'Fair-Mostly Clear (night).png',
                'cloudy': 'Cloudy.png',
                'fog': 'Foggy Conditions.png',
                'hail': 'Sleet.png',
                'lightning': 'Thunderstorms.png',
                'lightning-rainy': 'Thunderstorms.png',
                'partlycloudy': isNight ? 'Partly Cloudy (night).png' : 'Partly Cloudy (day).png',
                'pouring': 'Heavy Rain and Wind.png',
                'rainy': 'Rain.png',
                'snowy': 'Snow.png',
                'snowy-rainy': 'Rain and Snow.png',
                'sunny': 'Sunny.png',
                'windy': 'Windy Conditions.png',
                'windy-variant': 'Clear and Windy.png',
                'exceptional': 'Not Available.png'
            };
            
            const filename = iconMap[condition] || 'Sunny.png';
            return `${ASSETS_PATH}/${encodeURIComponent(filename)}`;
        }

        function getWeatherIcon(condition, isNight = false) {
            const iconPath = getWeatherIconPath(condition, isNight);
            return `<img src="${iconPath}" alt="${condition}" style="width: 100%; height: 100%; object-fit: contain;" onerror="this.style.display='none'; this.parentElement.innerHTML='<div style=\\'font-size:64px;\\'>${getIconFallback(condition)}</div>'">`;
        }

        // Fallback emoji icons if PNG fails to load
        function getIconFallback(condition) {
            const fallbacks = {
                'clear-night': 'ðŸŒ™',
                'cloudy': 'â˜ï¸',
                'fog': 'ðŸŒ«ï¸',
                'hail': 'ðŸ§Š',
                'lightning': 'âš¡',
                'lightning-rainy': 'â›ˆï¸',
                'partlycloudy': 'â›…',
                'pouring': 'ðŸŒ§ï¸',
                'rainy': 'ðŸŒ¦ï¸',
                'snowy': 'â„ï¸',
                'snowy-rainy': 'ðŸŒ¨ï¸',
                'sunny': 'â˜€ï¸',
                'windy': 'ðŸ’¨',
                'windy-variant': 'ðŸŒ¬ï¸',
                'exceptional': 'âš ï¸'
            };
            return fallbacks[condition] || 'ðŸŒ¤ï¸';
        }

        let currentSectionIndex = 0;
        const sections = ['current', 'forecast', 'text-forecast', 'regional'];
        let weatherData = null;
        let forecastData = null;

        // Get config ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const configId = urlParams.get('config_id');

        // Load configuration
        async function loadConfig() {
            if (!configId) {
                console.error('No config ID provided');
                return;
            }

            try {
                const tokenStr = window.parent.localStorage.getItem('hassTokens');
                if (!tokenStr) {
                    console.error('No Home Assistant token found');
                    return;
                }

                const tokens = JSON.parse(tokenStr);
                const response = await fetch(`/api/local_on_the_10s/config/${configId}`, {
                    headers: {
                        'Authorization': `Bearer ${tokens.access_token}`,
                        'Content-Type': 'application/json',
                    }
                });

                if (response.ok) {
                    config = await response.json();
                    updateLocationHeaders();
                    fetchWeather();
                }
            } catch (error) {
                console.error('Error loading config:', error);
            }
        }

        // Update all location headers
        function updateLocationHeaders() {
            const headers = document.querySelectorAll('[id^="location-header"]');
            headers.forEach(header => {
                header.textContent = config.display_name;
            });
            
            document.getElementById('footer-location').textContent = 
                config.region_name || config.display_name;
        }

        // Update time display
        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit'
            });
            document.getElementById('time-display').textContent = timeString;
        }

        // Fetch weather data
        async function fetchWeather() {
            try {
                const tokenStr = window.parent.localStorage.getItem('hassTokens');
                if (!tokenStr) return;

                const tokens = JSON.parse(tokenStr);
                
                // Fetch current weather state
                const response = await fetch('/api/states', {
                    headers: {
                        'Authorization': `Bearer ${tokens.access_token}`,
                        'Content-Type': 'application/json',
                    }
                });

                const states = await response.json();
                weatherData = states.find(entity => 
                    entity.entity_id === config.weather_entity
                );

                // Fetch forecast data using the weather service
                if (config.weather_entity) {
                    try {
                        const forecastResponse = await fetch('/api/services/weather/get_forecasts?return_response', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${tokens.access_token}`,
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                entity_id: config.weather_entity,
                                type: 'daily'
                            })
                        });

                        if (forecastResponse.ok) {
                            const forecastResult = await forecastResponse.json();
                            if (forecastResult && forecastResult.service_response && 
                                forecastResult.service_response[config.weather_entity]) {
                                forecastData = forecastResult.service_response[config.weather_entity].forecast;
                            }
                        }
                    } catch (err) {
                        console.error('Error fetching forecasts:', err);
                    }
                }

                if (weatherData) {
                    updateDisplay();
                }
            } catch (error) {
                console.error('Error fetching weather:', error);
            }
        }

        // Update the weather display
        function updateDisplay() {
            if (!weatherData) return;

            const attr = weatherData.attributes;
            
            // Update current conditions
            updateCurrentConditions(attr);
            
            // Update forecast
            if (forecastData && forecastData.length > 0) {
                updateForecast({ forecast: forecastData });
                updateTextForecast({ ...attr, forecast: forecastData });
            } else if (attr.forecast && attr.forecast.length > 0) {
                updateForecast(attr);
                updateTextForecast(attr);
            }
            
            // Update footer
            document.getElementById('footer-temp').textContent = 
                `${Math.round(attr.temperature)}Â°`;
        }

        function updateCurrentConditions(attr) {
            const section = document.getElementById('current-section').querySelector('.data-panel');
            
            // Determine if it's night
            const hour = new Date().getHours();
            const isNight = hour >= 19 || hour < 6;
            
            const iconHtml = getWeatherIcon(weatherData.state, isNight);
            
            const html = `
                <div class="current-layout">
                    <div class="current-icon-temp">
                        <div class="weather-icon-large">${iconHtml}</div>
                        <div class="condition-text">${formatCondition(weatherData.state)}</div>
                        <div class="temp-large">${Math.round(attr.temperature)}</div>
                    </div>
                    <div class="current-details">
                        <div class="detail-row">
                            <span class="detail-label">HUMIDITY</span>
                            <span class="detail-value">${attr.humidity}%</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">DEW POINT</span>
                            <span class="detail-value">${attr.dew_point ? Math.round(attr.dew_point) + 'Â°' : 'N/A'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">PRESSURE</span>
                            <span class="detail-value">${formatPressure(attr)}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">VISIBILITY</span>
                            <span class="detail-value">${formatVisibility(attr)}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">WIND</span>
                            <span class="detail-value">${formatWind(attr)}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">GUSTS</span>
                            <span class="detail-value">${formatGusts(attr)}</span>
                        </div>
                    </div>
                </div>
            `;
            
            section.innerHTML = html;
        }

        function updateForecast(attr) {
            if (!attr.forecast || attr.forecast.length === 0) {
                document.getElementById('forecast-grid').innerHTML = 
                    '<div style="grid-column: 1/-1; text-align: center; padding: 40px; font-size: 22px;">No forecast data available</div>';
                return;
            }
            
            const container = document.getElementById('forecast-grid');
            const html = attr.forecast.slice(0, 7).map(day => {
                const date = new Date(day.datetime);
                const dayName = date.toLocaleDateString('en-US', { weekday: 'short' }).toUpperCase();
                
                const highTemp = day.temperature !== undefined ? Math.round(day.temperature) : '--';
                const lowTemp = day.templow !== undefined ? Math.round(day.templow) : '--';
                
                const iconHtml = getWeatherIcon(day.condition, false);
                
                return `
                    <div class="forecast-card">
                        <div class="forecast-day">${dayName}</div>
                        <div class="forecast-icon">${iconHtml}</div>
                        <div class="forecast-condition">${formatCondition(day.condition)}</div>
                        <div class="forecast-temps">
                            <span class="temp-high">${highTemp}Â°</span>
                            <br>
                            <span class="temp-low">${lowTemp}Â°</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }

        function updateTextForecast(attr) {
            const container = document.getElementById('text-forecast');
            let text = '';
            
            if (attr.forecast && attr.forecast.length >= 2) {
                const today = attr.forecast[0];
                const tomorrow = attr.forecast[1];
                
                const hour = new Date().getHours();
                const isNight = hour >= 18 || hour < 6;
                
                const tonightTemp = today.templow !== undefined ? Math.round(today.templow) : '--';
                const tomorrowHigh = tomorrow.temperature !== undefined ? Math.round(tomorrow.temperature) : '--';
                const tomorrowLow = tomorrow.templow !== undefined ? Math.round(tomorrow.templow) : '--';
                
                text = `
                    <div class="forecast-period">${isNight ? 'Tonight' : 'This Evening'}</div>
                    <p>${formatCondition(today.condition)}. Low ${tonightTemp}Â°. 
                    Winds ${formatWindDirection(attr.wind_bearing)} at ${Math.round(attr.wind_speed)} ${attr.wind_speed_unit || 'km/h'}.</p>
                    
                    <div class="forecast-period">Tomorrow</div>
                    <p>${formatCondition(tomorrow.condition)}. High ${tomorrowHigh}Â°. Low ${tomorrowLow}Â°. ${tomorrow.precipitation_probability ? `Chance of precipitation ${tomorrow.precipitation_probability}%.` : ''}</p>
                `;
            } else {
                text = '<div style="padding: 20px; text-align: center;">Detailed forecast information not available</div>';
            }
            
            container.innerHTML = text;
        }

        function formatCondition(condition) {
            if (!condition) return 'Unknown';
            const formatted = condition.split('-').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
            
            return formatted
                .replace('Partlycloudy', 'Partly Cloudy');
        }
        
        function formatPressure(attr) {
            if (!attr.pressure) return 'N/A';
            const pressure = attr.pressure;
            const unit = attr.pressure_unit || 'hPa';
            
            if (unit === 'hPa' || unit === 'mbar') {
                const inches = (pressure * 0.02953).toFixed(2);
                return `${inches} inches`;
            }
            return `${pressure} ${unit}`;
        }
        
        function formatVisibility(attr) {
            if (!attr.visibility) return 'N/A';
            const vis = attr.visibility;
            const unit = attr.visibility_unit || 'km';
            
            if (unit === 'km') {
                const miles = (vis * 0.621371).toFixed(0);
                return `${miles} miles`;
            }
            return `${vis} ${unit}`;
        }
        
        function formatWind(attr) {
            if (!attr.wind_speed) return 'Calm';
            const speed = Math.round(attr.wind_speed);
            const direction = formatWindDirection(attr.wind_bearing);
            return `${direction} ${speed}`;
        }
        
        function formatGusts(attr) {
            if (!attr.wind_gust_speed) return 'None';
            const speed = Math.round(attr.wind_gust_speed);
            return `${speed}`;
        }
        
        function formatWindDirection(bearing) {
            if (!bearing && bearing !== 0) return '';
            const directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
            const index = Math.round(bearing / 22.5) % 16;
            return directions[index];
        }

        // Rotate sections
        function rotateSection() {
            const current = document.getElementById(`${sections[currentSectionIndex]}-section`);
            current.classList.remove('active');
            
            currentSectionIndex = (currentSectionIndex + 1) % sections.length;
            
            const next = document.getElementById(`${sections[currentSectionIndex]}-section`);
            next.classList.add('active');
            
            // Update background image
            updateBackground();
        }

        // Initialize
        setBackgroundImage(0); // Set initial background
        updateTime();
        setInterval(updateTime, 1000);
        
        loadConfig();
        setInterval(fetchWeather, 300000);
        
        setInterval(() => {
            rotateSection();
        }, (config.display_duration || 10) * 1000);
    </script>
</body>
</html>
